version: 2.1

orbs:
  # This uses the Orbs located at https://github.com/wordpress-mobile/circleci-orbs
  ios: wordpress-mobile/ios@0.0.31

commands:
  load-chruby:
    steps:
      - run:
          name: Load chruby
          command: |
            # Force chruby to load to work around CircleCI Xcode 11 image issue
            echo 'source /usr/local/opt/chruby/share/chruby/chruby.sh && chruby 2.5.5' >> $BASH_ENV

jobs:
  Test:
    executor:
      name: ios/default
      xcode-version: "11.0.0"
    steps:
      - checkout
      - load-chruby
      - run:
          name: Copy demo SPCredentials
          command: mkdir -p Simplenote/Credentials && cp Simplenote/SPCredentials-demo.swift Simplenote/Credentials/SPCredentials.swift
      - ios/test:
          xcode-version: "11.0.0"
          workspace: Simplenote.xcworkspace
          scheme: Simplenote
          device: iPhone 11

  Installable Build:
    executor:
      name: ios/default
      xcode-version: "11.0.0"
    steps:
      - git/shallow-checkout
      - ios/install-dependencies:
            bundle-install: true
            pod-install: true
      - run:
          name: Copy Secrets
          command: bundle exec fastlane run configure_apply
      - run:
          name: Build
          working_directory: Scripts
          command: "bundle exec fastlane build_and_upload_installable_build build_number:$CIRCLE_BUILD_NUM"
      - run:
          name: Prepare Artifacts
          command: |
            mkdir -p Artifacts
            mv "fastlane/comment.json" "Artifacts/comment.json"
      - store_artifacts:
          path: Artifacts
          destination: Artifacts

workflows:
  simplenote_ios:
    jobs:
      - Test
  Installable Build:
    jobs:
      - Hold:
          type: approval
          filters:
            branches:
              ignore: /pull\/[0-9]+/
      - Installable Build:
          requires: [Hold]  
          filters:
            branches:
              ignore: /pull\/[0-9]+/

